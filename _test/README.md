# utm.codes Tests

The following should get you up and running PHPUnit tests for the utm.codes plugin.

## Contents

```
.
├── bin
└── tests
```

- **bin** - WordPress test suite install script
- **tests** - PHPUnit tests for our plugin

## Compatibility

Tests support phpunit 5.7 (for PHP 5.6) and phpunit 6.5 (for PHP 7.0, 7.1, and 7.2)


## Initial Setup


### 1. Installing WordPress Tests (Automated)

The install script contained in `bin` will checkout the latest test suite from WordPress and configure your test database. 

> Note: The install script is included here for convenience but can also be [generated by WP-CLI](https://developer.wordpress.org/cli/commands/scaffold/plugin-tests/).

### 1b. Manual Setup

Alternatively you can [checkout the test suite](https://develop.svn.wordpress.org/trunk/) from WordPress svn and setup your database manually [in the usual manner](https://codex.wordpress.org/Installing_WordPress).

### 2. Configuring Local Environment

Update the `config.inc.php` file to your needs:

- **WP\_TEST\_DIR** - Path to the WordPress tests directory you setup in Step 1
- **UTMDC\_PLUGIN\_DIR** - Path to the utm.codes plugin you're testing
- **UTMDC\_BITLY\_API** - A valid Bitly API Generic Access Token

> Note: Rename to `config.inc.local.php` (ignored in .gitignore) for environment personalization.

## Running Tests

From the `_test` directory execute `$ phpunit` to run the tests. This should result in output similar to:

```
Installing...
Running as single site... To run multisite, use -c tests/phpunit/multisite.xml
Not running ajax tests. To execute these, use --group ajax.
Not running ms-files tests. To execute these, use --group ms-files.
Not running external-http tests. To execute these, use --group external-http.
PHPUnit 6.5.6 by Sebastian Bergmann and contributors.

...................................                               35 / 35 (100%)

Time: 18.52 seconds, Memory: 46.25MB

OK (35 tests, 327 assertions)

Generating code coverage report in Clover XML format ... done
```

#### Gotchas

Occasionally a newly installed test suite can throw the error:

```
1) TestUtmDotCodesUnit::test_is_test
UnexpectedValueException: RecursiveDirectoryIterator::__construct(/tmp/wordpress//wp-content/uploads): 
failed to open dir: No such file or directory
```

This occurs because WordPress creates the uploads directory at runtime the first time you run the tests. If the directory doesn't exist and you don't have permission to create it there will be an error.

This can be resolved my running `$ sudo phpunit` or by manually creating the directory within the test suite source.

Subsequent runs against the same test suite should not require sudo.
